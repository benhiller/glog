<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>glog - Live Log Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background-color: #2d2d30;
            padding: 1rem;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ff6b6b;
            transition: background-color 0.3s;
        }
        
        .status-dot.connected {
            background-color: #51cf66;
        }
        
        .log-container {
            height: calc(100vh - 120px);
            overflow-y: auto;
            padding: 1rem;
            scroll-behavior: smooth;
        }
        
        .log-entry {
            display: flex;
            gap: 1rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid #2d2d30;
            word-wrap: break-word;
        }
        
        .timestamp {
            color: #6b7280;
            font-size: 0.875rem;
            white-space: nowrap;
            min-width: 180px;
        }
        
        .message {
            flex: 1;
            white-space: pre-wrap;
        }
        
        .filter-container {
            padding: 0 1rem;
            background-color: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            height: 40px;
        }
        
        .filter-input {
            flex: 1;
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            color: #d4d4d4;
            font-family: inherit;
            font-size: 0.875rem;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #0078d4;
        }
        
        .filter-label {
            font-size: 0.875rem;
            color: #6b7280;
            white-space: nowrap;
        }

        .controls {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .btn {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .btn:hover {
            background-color: #106ebe;
        }
        
        .btn.secondary {
            background-color: #6b7280;
        }
        
        .btn.secondary:hover {
            background-color: #4b5563;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">glog - Live Log Viewer</div>
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Disconnected</span>
        </div>
    </div>
    
    <div class="filter-container">
        <span class="filter-label">Filter:</span>
        <input type="text" class="filter-input" id="filterInput" placeholder="Type to filter log messages...">
    </div>
    
    <div class="log-container" id="logContainer">
        <div class="log-entry">
            <div class="timestamp">--:--:--</div>
            <div class="message">Waiting for log data...</div>
        </div>
    </div>
    
    <div class="controls">
        <button class="btn secondary" onclick="clearLogs()">Clear</button>
        <button class="btn secondary" onclick="toggleAutoscroll()" id="autoscrollBtn">Autoscroll: ON</button>
    </div>

    <script>
        let ws;
        let autoscroll = true;
        let filterText = '';
        let allLogEntries = [];
        const logContainer = document.getElementById('logContainer');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const autoscrollBtn = document.getElementById('autoscrollBtn');
        const filterInput = document.getElementById('filterInput');
        
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
                console.log('Connected to glog server');
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addLogEntry(data.timestamp, data.message);
                } catch (e) {
                    console.error('Error parsing message:', e);
                }
            };
            
            ws.onclose = function() {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
                console.log('Disconnected from glog server');
                
                // Attempt to reconnect after 2 seconds
                setTimeout(connect, 2000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }
        
        function parseAnsiColors(text) {
            // ANSI color codes mapping
            const colorMap = {
                '30': '#000000', '31': '#ff6b6b', '32': '#51cf66', '33': '#ffd43b',
                '34': '#339af0', '35': '#cc5de8', '36': '#22b8cf', '37': '#ffffff',
                '90': '#6b7280', '91': '#ff8787', '92': '#8ce99a', '93': '#ffe066',
                '94': '#74c0fc', '95': '#da77f2', '96': '#66d9ef', '97': '#f8f9fa'
            };
            
            const bgColorMap = {
                '40': '#000000', '41': '#ff6b6b', '42': '#51cf66', '43': '#ffd43b',
                '44': '#339af0', '45': '#cc5de8', '46': '#22b8cf', '47': '#ffffff',
                '100': '#6b7280', '101': '#ff8787', '102': '#8ce99a', '103': '#ffe066',
                '104': '#74c0fc', '105': '#da77f2', '106': '#66d9ef', '107': '#f8f9fa'
            };
            
            let html = '';
            let currentStyles = '';
            let i = 0;
            
            while (i < text.length) {
                if (text[i] === '\x1b') {
                    // Check for different types of ANSI escape sequences
                    if (text[i + 1] === '[') {
                        // CSI (Control Sequence Introducer) sequences like colors
                        let j = i + 2;
                        while (j < text.length && /[0-9;]/.test(text[j])) {
                            j++;
                        }
                        
                        if (j < text.length && text[j] === 'm') {
                            // This is a color/style sequence
                            const codes = text.substring(i + 2, j).split(';');
                            let styles = '';
                            
                            for (const code of codes) {
                                if (code === '0' || code === '') {
                                    // Reset
                                    styles = '';
                                    break;
                                } else if (code === '1') {
                                    styles += 'font-weight: bold; ';
                                } else if (code === '3') {
                                    styles += 'font-style: italic; ';
                                } else if (code === '4') {
                                    styles += 'text-decoration: underline; ';
                                } else if (colorMap[code]) {
                                    styles += `color: ${colorMap[code]}; `;
                                } else if (bgColorMap[code]) {
                                    styles += `background-color: ${bgColorMap[code]}; `;
                                }
                            }
                            
                            if (currentStyles && styles !== currentStyles) {
                                html += '</span>';
                            }
                            
                            if (styles) {
                                html += `<span style="${styles}">`;
                                currentStyles = styles;
                            } else {
                                currentStyles = '';
                            }
                            
                            i = j + 1;
                        } else {
                            // Unknown CSI sequence - skip it entirely
                            while (j < text.length && !/[a-zA-Z]/.test(text[j])) {
                                j++;
                            }
                            if (j < text.length) {
                                j++; // Skip the final letter
                            }
                            i = j;
                        }
                    } else if (text[i + 1] === ']') {
                        // OSC (Operating System Command) sequences
                        let j = i + 2;
                        while (j < text.length && text[j] !== '\x07' && text[j] !== '\x1b') {
                            j++;
                        }
                        if (j < text.length) {
                            if (text[j] === '\x1b' && text[j + 1] === '\\') {
                                j += 2; // Skip ESC\
                            } else {
                                j++; // Skip BEL
                            }
                        }
                        i = j;
                    } else {
                        // Other escape sequences (ESC followed by single character)
                        i += 2;
                    }
                } else {
                    html += text[i] === '<' ? '&lt;' : 
                           text[i] === '>' ? '&gt;' : 
                           text[i] === '&' ? '&amp;' : text[i];
                    i++;
                }
            }
            
            if (currentStyles) {
                html += '</span>';
            }
            
            return html;
        }

        function addLogEntry(timestamp, message) {
            // Store the log entry data
            const logData = { timestamp, message };
            allLogEntries.push(logData);
            
            // Apply current filter
            applyFilter();
        }
        
        function createLogElement(timestamp, message) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestampEl = document.createElement('div');
            timestampEl.className = 'timestamp';
            timestampEl.textContent = new Date(timestamp).toLocaleTimeString();
            
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            messageEl.innerHTML = parseAnsiColors(message);
            
            logEntry.appendChild(timestampEl);
            logEntry.appendChild(messageEl);
            
            return logEntry;
        }
        
        function applyFilter() {
            // Clear the container
            logContainer.innerHTML = '';
            
            // Filter entries based on current filter text
            const filteredEntries = filterText ? 
                allLogEntries.filter(entry => 
                    entry.message.toLowerCase().includes(filterText.toLowerCase())
                ) : allLogEntries;
            
            // Add filtered entries to the container
            filteredEntries.forEach(entry => {
                const logElement = createLogElement(entry.timestamp, entry.message);
                logContainer.appendChild(logElement);
            });
            
            // Show placeholder if no entries
            if (filteredEntries.length === 0 && allLogEntries.length > 0) {
                const placeholder = document.createElement('div');
                placeholder.className = 'log-entry';
                placeholder.innerHTML = '<div class="timestamp">--:--:--</div><div class="message">No messages match the current filter</div>';
                logContainer.appendChild(placeholder);
            } else if (allLogEntries.length === 0) {
                const placeholder = document.createElement('div');
                placeholder.className = 'log-entry';
                placeholder.innerHTML = '<div class="timestamp">--:--:--</div><div class="message">Waiting for log data...</div>';
                logContainer.appendChild(placeholder);
            }
            
            // Auto-scroll to bottom if enabled
            if (autoscroll && filteredEntries.length > 0) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }
        
        function clearLogs() {
            allLogEntries = [];
            logContainer.innerHTML = '';
            const placeholder = document.createElement('div');
            placeholder.className = 'log-entry';
            placeholder.innerHTML = '<div class="timestamp">--:--:--</div><div class="message">Waiting for log data...</div>';
            logContainer.appendChild(placeholder);
        }
        
        function toggleAutoscroll() {
            autoscroll = !autoscroll;
            autoscrollBtn.textContent = `Autoscroll: ${autoscroll ? 'ON' : 'OFF'}`;
        }
        
        // Set up filter input event listener
        filterInput.addEventListener('input', function(e) {
            filterText = e.target.value;
            applyFilter();
        });
        
        // Set up scroll event listener to auto-toggle autoscroll based on scroll position
        logContainer.addEventListener('scroll', function() {
            // Check if user is at the bottom (within 5px tolerance)
            const isAtBottom = logContainer.scrollTop >= logContainer.scrollHeight - logContainer.clientHeight - 5;
            
            // Auto-toggle autoscroll based on scroll position
            if (autoscroll && !isAtBottom) {
                // User scrolled up from bottom - disable autoscroll
                autoscroll = false;
                autoscrollBtn.textContent = 'Autoscroll: OFF';
            } else if (!autoscroll && isAtBottom) {
                // User scrolled back to bottom - enable autoscroll
                autoscroll = true;
                autoscrollBtn.textContent = 'Autoscroll: ON';
            }
        });
        
        // Start connection
        connect();
    </script>
</body>
</html>